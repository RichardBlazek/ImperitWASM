@inject ImperitClient http;

@using Mode = Data.View;

@code{
	[Parameter] public Data.Session Session { get; set; } = new Data.Session();
	[Parameter] public Func<Task>? LogoutAsync { get; set; }
	Task DoLogoutAsync()
	{
		timer.Stop();
		return LogoutAsync!();
	}
	Mode Current;
	int? From = null, To = null;
	(int, int, string)? Player = null;
	void Switch(Mode mode = Mode.Map, int? from = null, int? to = null, (int, int, string)? player = null)
	{
		Current = mode;
		From = from;
		To = to;
		Player = player;
		this.StateHasChanged();
	}
	GameMap? Map { get; set; }
	async Task NextTurnAsync()
	{
		if (await http.PostAsync<Data.Session, bool>("api/Game/NextTurn", Session))
		{
			await DoLogoutAsync();
		}
		else
		{
			Info = await http.PostAsync<int, Data.GameInfo>("api/Game/Info", Session.G);
			Map?.Update();
		}
	}
	async Task CheckSession()
	{
		Info = await http.PostAsync<int, Data.GameInfo>("api/Game/Info", Session.G);
		if (!Info.S)
		{
			await DoLogoutAsync();
		}
	}
	Color PlayerColor = new Color();
	Data.GameInfo Info = new Data.GameInfo();
	Data.DisplayableShape[]? Provinces = null;
	System.Timers.Timer timer = new System.Timers.Timer(400);
	protected override async Task OnInitializedAsync()
	{
		await CheckSession();
		PlayerColor = await http.PostAsync<Data.PlayerId, Color>("api/Player/Color", new Data.PlayerId(Session.P, Session.G));
		Provinces = await http.PostAsync<int, Data.DisplayableShape[]>("api/Provinces/Shapes", Session.G);
		timer.Elapsed += async (sender, e) => await CheckSession();
		timer.Start();
	}
	public void UpdateProvinces(Data.ProvinceVariables[] variables)
	{
		if (Provinces is not null && variables.Length <= Provinces.Length)
		{
			variables.Each((variable, i) => Provinces[i] = Provinces[i].Update(variable.F, variable.T));
		}
	}
}

<style>
	nav > a:hover {
		background-color: @PlayerColor.WithAlpha(96);
	}
	nav > a.this {
		background-color: @PlayerColor;
	}
</style>

@if (Current == Mode.Map)
{
	<GameMap UpdateProvinces="UpdateProvinces" @ref="Map" Provinces="Provinces" IsActive="Info.P == Session.P" Switch="(x, y, z) => Switch(x, y, z, null)" Preview="false" Session="Session" LogoutAsync="DoLogoutAsync" NextTurnAsync="NextTurnAsync"/>
}
else if (Current == Mode.Preview)
{
	<GameMap UpdateProvinces="UpdateProvinces" Provinces="Provinces" IsActive="Info.P == Session.P" Switch="(x, y, z) => Switch(x, y, z, null)" Preview="true" Session="Session" LogoutAsync="DoLogoutAsync" NextTurnAsync="NextTurnAsync"/>
}
else if (Current == Mode.Donation && Player is (int Money, int Recipient, string Name))
{
	<Donation Session="Session" Recipient="Recipient" RecipientName="@Name" Return="() => Switch()" PlayerMoney="Money"/>
}
else if (Current == Mode.Move && From is int from && To is int to)
{
	<Move Session="Session" From="from" To="to" Return="() => Switch()"/>
}
else if (Current == Mode.Players)
{
	<Players Session="Session" Switch="Switch" LogoutAsync="DoLogoutAsync"/>
}
else if (Current == Mode.Powers)
{
	<Powers Return="() => Switch()" Session="Session"/>
}
else if (Current == Mode.Purchase && From is int from2)
{
	<Purchase Session="Session" Land="from2" Return="() => Switch()"/>
}
else if (Current == Mode.Recruit && From is int from3)
{
	<Recruitment Session="Session" Land="from3" Switch="x => Switch(x, null, null, null)"/>
}